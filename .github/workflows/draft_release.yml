name: Build and deploy phar file
on:
  push:
    tags:
      - "v*.*.*"
jobs:
  tests:
    name: test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Setup PHP, with composer and extensions
        uses: shivammathur/setup-php@v2
        with:
          php-version: 8.0
          extensions: json
          coverage: none
      - name: Get composer cache directory
        id: composer-cache
        run: echo "::set-output name=dir::$(composer config cache-files-dir)"
      - name: Cache composer dependencies
        uses: actions/cache@v2
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.json') }}
          restore-keys: ${{ runner.os }}-composer-
      - name: Install dependencies
        run: composer install --no-progress --no-suggest --prefer-dist --optimize-autoloader
      - name: Test with phpunit
        run: composer test
  build:
    needs: tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Setup PHP, with composer and extensions
        uses: shivammathur/setup-php@v2
        with:
          php-version: 8.0
          extensions: json
          coverage: none
      - name: Download Box
        run: wget https://github.com/box-project/box/releases/download/3.13.0/box.phar
      - name: Build the phar archive
        run: php box.phar compile
      - id: get_version
        uses: battila7/get-version-action@v2
      - name: Build Release Changelog
        id: build_changelog
        uses: mikepenz/release-changelog-builder-action@v2
      - name: Release
        uses: softprops/action-gh-release@v1
        with:
          name: Release ${{ steps.get_version.outputs.version-without-v }}
          body: ${{ steps.build_changelog.outputs.changelog }}
          files: |
            pdf-compressor.phar
